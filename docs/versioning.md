# Versioning

This section describes S3 Server's support for the specific AWS S3 Bucket
Versioning feature.

## AWS S3 Bucket Versioning

An object in a versioning enabled bucket can have multiple versions, whereas an
object can have only a single version in a standard bucket without versioning.

With the standard S3 API, any update (PUT, DELETE) to an object in a versioning
enabled bucket would create a new version of that object. A standard DELETE on
a versioned bucket creates delete markers instead of deleting object data (see
"Delete Markers" section for further information).

Read operations such as GET and LIST would see the latest version of the
objects. The table below shows an example on a standard bucket: a `PUT foo`
generates a new version `v2` and keeps `v1`; GET and LIST return the latest
version of `foo`, which is `v2` in this case.

| key | version | value |
|-----|:-------:|:-----:|
| foo |   v2    |   B   |
| foo |   v1    |   A   |

To work with all existing versions of an object, S3 provides an extended
API which uses the same operations of the standard API, but with versioning
information specified. For example, in order to get the version `v1` of `foo`,
users have to specify that version in the query, such as
`GET /foo?versionId=v1`.

A bucket can be non-versioning or versioning. Any object placed in a bucket
before versioning is enabled is considered to be the "null" version. When
versioning is enabled, the "null" version will be kept and continue to be
identified as the "null" version. However, if versioning is suspended, the
"null" version may be overwritten with a new "null" version. All versions with
a version ID other than "null" are retained when versioning is suspended, even
when there are new puts on the object.

## Implementation of Bucket Versioning in S3

### Roles of Metadata Engine and API Component

Each version of an object is stored as a separate key in metadata. The API
component of S3 manages the put and delete of version data, sends instructions
to create, retrieve, overwrite or delete a version's metadata to the metadata
backend, and stores and retrieves extra information about a version, such as
whether it is a delete marker or a null version, in the object's metadata.

The metadata backend is responsible for handling the create, overwrite and
delete operations of version metadata upon receiving instructions. We use
version identifiers as the suffix for the keys of the object versions, and a
special version to represent the latest version.

This is an example of what the keys may look like in metadata, for an object
`foo/bar` with three versions. The latest version is represented below in the
key `foo/bar`. This special version is called the master version and is
described further in one of the following sections, "Master Version".

| key |
|-----|
| foo/bar |
| foo/bar\098506163554375999999PARIS  0.a430a1f85c6ec |
| foo/bar\098506163554373999999PARIS  0.41b510cd0fdf8 |
| foo/bar\098506163554373999998PARIS  0.f9b82c166f695 |

The following is a summary of the design and implementation details of bucket
versioning, described first for the metadata engine and then for the API.

## Implementation of Bucket Versioning in Metadata

### Version Id and Metadata Key Format

The version ID is generated by the metadata backend, and encoded in a
hexadecimal string format by S3 before sending a response to a request. S3 also
decodes the hexadecimal string received from a request before sending to
metadata to retrieve a particular version.

The format of a `version_id` is:
`ts` `rep_group_id` `seq_id`
where:

- `ts`: is the combination of epoch and an increasing number
- `rep_group_id`: is the name of deployment(s) considered one unit used for
   replication
- `seq_id`: is supposed to be a unique value based on metadata information.

The format of a key in metadata for a version is:

`object_name separator version_id`
where:

- `object_name`: is the key of the object in metadata
- `separator`: we use the `null` character (`0x00` or `\0`) as the separator
  between the `object_name` and the `version_id` of a key
- `version_id`: is the version identifier; this encodes the ordering
  information in the format described above as metadata orders keys
  alphabetically

An example of a key in metadata: `foo\01234567890000777PARIS 1234.123456`
indicating that this specific version of `foo` was the `000777`th entry created
during the epoch `1234567890` in the replication group `PARIS` with
`1234.123456` as `seq_id`.

### Master Version

We store a copy of the latest version of an object's metadata using
`object_name` as the key; this version is called the master version. The master
versions of each object facilitates the standard GET operation, which would
otherwise need to scan among the list of versions of an object for its latest
version.

The following table shows the layout of all versions of `foo` in the first
example stored in the metadata (with dot `.` representing the null separator):

| key | value |
|-----|:-----:|
| foo |   B   |
| foo.v2 |   B   |
| foo.v1 |   A   |

### Metadata Versioning Options

S3 Server sends instructions to the metadata engine about whether to create a
new version or overwrite, retrieve, or delete a specific version by sending
values for special options in PUT, GET, or DELETE calls to metadata.

Note: all operations (PUT and DELETE) that generate a new version of an object
will return the `version_id` of the new version to the API.

Note also that these describe only the basic CRUD operations that the metadata
engine can handle. How these options are used by the S3 API to generate and
update versions involves additional considerations and is described more
comprehensively in the section "Implementation of Bucket Versioning in API"
and its subsections.

#### PUT

- no options: original PUT operation, will update the master version
- `versioning: true` create a new version of the object,
  then update the master version with this version.
- `versionId: <versionId>` update a specific version (for updating version's ACL
  or tags, or remote updates in geo-replication);
  - if the version identified by `versionId` happens to be the latest version,
    the master version will be updated as well
  - note that with `versionId` set to an empty string `''`, it will overwrite
    the master version only (same as no options, but returns a version ID).
    This is used for creating null versions, which are discussed further in
    "Null Version Management."

Only one option is used at a time. `versionId: <versionId>` does not have to be
used with `versioning: true` set to work, nor should they both be set. If both
are used at once, the metadata engine will not perform any action.

To summarize the valid combinations of versioning options:

- !versioning && !versionId: normal non-versioning put
- versioning && !versionId: create a new version, update the master version
- !versioning && versionId: update (PUT/DELETE) an existing version
  - if versionId === '' update master version

Other cases are invalid and metadata does nothing.

#### DELETE

- no options: original DELETE operation, will delete the master version
- `versionId: <versionId>` delete a specific version

Deleting a specific version in metadata involves a few steps. A deletion
targeting the latest version of an object has to:

- delete the specified version identified by `versionId`
- replace the master version with a version that is a placeholder for deletion
  - this version contains a special keyword, 'isPHD', to indicate the master
  version was deleted and needs to be updated
- initiate a repair operation to update the value of the master version:
  - involves listing the versions of the object and get the latest
  version to replace the place holder delete version
  - if no more versions exists, metadata deletes the master version, removing
    the key from metadata

Note: all of this happens before responding to S3, and only when the metadata
engine is instructed by S3 to delete a specific version or the master version.
See section "Delete Markers" for a description of what happens when a delete
object request is sent to the S3 API.

#### GET

- no options: original GET operation, will get the master version
- `versionId: <versionId>` retrieve a specific version

The implementation of a GET operation does not change compared to the standard
version. A standard GET without versioning information would get the master
version of a key. A version-specific GET would retrieve the specific version
identified by the key for that version.

#### LIST

For a standard LIST on a bucket, metadata iterates through the keys by using
the separator represented by `.` as an extra delimiter. For a listing of all
versions of a bucket, there is no change compared to the original listing
function. Instead, the API component returns all the keys in a List Objects call
and filters for just the keys of the master versions in a List Object Versions
call.

For example, a standard LIST operation against the keys in a table below would
return from metadata the list of `[ foo/bar, bar, qux/quz, quz ]` using the
separator represented by `.` as the extra delimiter.

| key |
|-----|
| foo/bar |
| foo/bar.v2 |
| foo/bar.v1 |
| bar |
| qux/quz |
| qux/quz.v2 |
| qux/quz.v1 |
| quz |
| quz.v2 |
| quz.v1 |

## Implementation of Bucket Versioning in API

### Object Metadata Versioning Attributes

To access all the information needed to properly handle all cases that may exist
in versioned operations, the API stores certain versioning-related information
in the metadata attributes of each version's object metadata.

These are the versioning-related metadata properties:

- `isNull`: whether the version being stored is a null version.
- `nullVersionId`: the unencoded version ID of the latest null version that
  existed before storing a non-null version.
- `isDeleteMarker`: whether the version being stored is a delete marker.

The metadata engine also sets one additional metadata property when creating
the version.

- `versionId`: the unencoded version ID of the version being stored.

Null versions and delete markers are described in further detail in the
following sections.

### Creation of New Versions

When versioning is enabled in a bucket, APIs which normally result in the
creation of objects, such as Put Object, Complete Multipart Upload and Copy
Object, will generate new versions of objects.

S3 creates a new version and updates the master version using the
`versioning: true` option in PUT calls to the metadata engine. As an example,
when two consecutive Put Object requests are sent to the S3 Server for a
versioning-enabled bucket with the same key names, there are two corresponding
metadata PUT calls with the `versioning` option set to true.

The PUT calls to metadata and resulting keys are shown below:

(1) PUT foo (first put), versioning: `true`

| key | value |
|-----|:-----:|
| foo |   A   |
| foo.v1 |   A   |

(2) PUT foo (second put), versioning: `true`

| key | value |
|-----|:-----:|
| foo |   B   |
| foo.v2 |   B   |
| foo.v1 |   A   |

#### Null Version Management

In a bucket without versioning, or when versioning is suspended, putting an
object with the same name twice should result in the previous object being
overwritten. This is managed with null versions.

Null versions are generated when an object is put before versioning is enabled
or when versioning is suspended, and are distinguished from normal versions in
that they are overwritten by new null versions. Therefore, only one null version
should exist at any given time, and it can be identified in S3 requests and
responses with the version id "null".

##### Case 1: Putting Null Versions

With respect to metadata, since the null version is overwritten by subsequent
null versions, the null version is initially stored in the master key alone,
as opposed to being stored in the master key and a new version. The metadata
engine does not differentiate between null and normal versions, so S3 checks if
versioning is suspended or has never been configured, and sets the `versionId`
option to `''` in PUT calls to the metadata engine when creating a new null
version.

The tables below show the keys resulting from PUT calls to metadata if we put an
object 'foo' twice, when versioning has not been enabled or is suspended.

(1) PUT foo (first put), versionId: `''`

| key | value |
|-----|:-----:|
| foo (null) |   A   |-

(2) PUT foo (second put), versionId: `''`

| key | value |
|-----|:-----:|
| foo (null) |   B   |

The S3 API also sets the `isNull` attribute to `true` in the version metadata
before storing the metadata for these null versions.

##### Case 2: Preserving Existing Null Versions in Versioning-Enabled Bucket

Null versions are preserved when versioning has been enabled or re-enabled, and
new non-null versions are created. To determine whether the master version is
a null version and needs to be preserved, the S3 API checks if the master
version's `isNull` property is set to `true`, or if the `versionId` attribute of
the master version is undefined (indicating it is a null version that was put
before bucket versioning was configured).

If the master version is the null version, the S3 API stores the current null
version as a new key `(3A)` in a separate PUT call to metadata, prior to
overwriting the master version `(3B)`. This implies the null version may not
necessarily be the latest or master version.

Continuing the example from Case 1, if we enabled versioning and put another
object, the calls to metadata and resulting keys would resemble the following:

(3A) PUT foo, versionId: `<versionId of master version>` if defined or
 `<non-versioned object id>`

| key | value |
|-----|:-----:|
| foo |   B   |
| foo.v1 (null) |   B   |

(3B) PUT foo, versioning: `true`

| key | value |
|-----|:-----:|
| foo |   C   |
| foo.v2 |   C   |
| foo.v1 (null) |   B   |

To prevent issues with concurrent requests, S3 ensures the null version is
stored with the same version ID by using `versionId` option. S3 sets the
`versionId` option to the master version's `versionId` metadata attribute value
during the PUT. This creates a new version with the same version ID of the
existing null master version.

The null version's `versionId` attribute may be undefined because it was
generated before the bucket versioning was configured. In that case, a version
ID is generated using the max timestamp and sequence values possible so that the
null version will be properly ordered as the last entry in a metadata listing.
This value ("non-versioned object id") is used in the PUT call with the
`versionId` option.

##### Case 3: Overwriting a Null Version That is Not Latest Version

Note that in the case versioning is suspended and there is a null version is not
the latest version, S3 cannot rely on the `versionId: ''` option during a PUT to
metadata to overwrite the existing null version when creating a new null
version. Instead, the S3 API must send a separate DELETE call to metadata
specifying the version id of the current null version for delete when creating a
new null version.

Therefore, when storing a null version (3A above) before storing a new non-null
version, S3 records the version ID returned by metadata in the `nullVersionId`
attribute of the non-null version. For steps 3A and 3B above, these are the
values stored in the `nullVersionId` of each version's metadata:

(3A) PUT foo, versioning: `true`

| key | value | value.nullVersionId |
|-----|:-----:|:-------------------:|
| foo |   B   |      undefined      |
| foo.v1 (null) |   B   |      undefined      |

(3B) PUT foo, versioning: `true`

| key | value | value.nullVersionId |
|-----|:-----:|:-------------------:|
| foo |   C   |         v1          |
| foo.v2 |   C   |         v1          |
| foo.v1 (null) |   B   |      undefined      |

If defined, the `nullVersionId` of the master version is used with the
`versionId` option in a DELETE call to metadata if a Put Object request
is received when versioning is suspended in a bucket.

(4A) DELETE foo, versionId: `<nullVersionId of master version>` (v1)

| key | value |
|-----|:-----:|
| foo |   C   |
| foo.v2 |   C   |

Then the master version is overwritten with the new null version:

(4B) PUT foo, versionId: `''`

| key | value |
|-----|:-----:|
| foo (null) |   D   |
| foo.v2 |   C   |

The `nullVersionId` attribute is also used to retrieve the correct version when
the version ID "null" is specified in certain object-level APIs, described
further in the section "Null Version Mapping".

#### Specifying Versions in APIs for Putting Versions

Since S3 does not currently allow overwrite of existing version data, Put
Object, Complete Multipart Upload and Copy Object return `400 InvalidArgument`
if a specific version ID is specified in the request query, e.g. for a
`PUT /foo?versionId=v1` request.

### PUT Example

When S3 receives a request to PUT an object:

- It checks first if versioning has been configured
- If it has not been configured, S3 proceeds to puts the new data, puts the
  metadata by overwriting the master version, and proceeds to delete any
  pre-existing data

If versioning has been configured, S3 checks the following:

#### Versioning Enabled

If versioning is enabled and there is existing object metadata:

- If the master version is a null version (`isNull: true`) or has no version ID
    (put before versioning was configured):
    - store the null version metadata as a new version
    - create a new version and overwrite the master version
        - set `nullVersionId`: version ID returned when storing null version

If versioning is enabled and the master version is not null;
or there is no existing object metadata:

- create a new version and store it, and overwrite the master version

#### Versioning Suspended

If versioning is suspended and there is existing object metadata:

- If the master version is a null version or has no version ID:
    - overwrite the master version with the new metadata
    - delete previous object data
- If master is not a null version and `nullVersionId` is defined in the objectâ€™s
  metadata:
    - delete the current null version metadata and data
    - overwrite the master version with the new metadata

If there is no existing object metadata, create the new null version as the
master version.

In each of the above cases, set `isNull` metadata attribute to true when
creating the new null version.

### Behavior of Object-Targeting APIs

API methods which can target existing objects or versions, such as Get Object,
Head Object, Get Object ACL, Put Object ACL, Copy Object and Copy Part, will
perform the action on the latest version of an object if no version ID is
specified in the request query or relevant request header
(`x-amz-copy-source-version-id` for Copy Object and Copy Part APIs).

Two exceptions are the Delete Object and Multi-Object Delete APIs, which will
instead attempt to create delete markers, described in the following section, if
no version ID is specified.

No versioning options are necessary to retrieve the latest version from
metadata, since the master version is stored in a key with the name of the
object. However, when updating the latest version, such as with the Put Object
ACL API, S3 sets the `versionId` option in the PUT call to metadata
to the value stored in the object metadata's `versionId` attribute. This is done
in order to update the metadata both in the master version and the version
itself, if it is not a null version.

When a version id is specified in the request query for these APIs, e.g.
`GET /foo?versionId=v1`, S3 will attempt to decode the version ID and
perform the action on the appropriate version. To do so, the API
sets the value of the `versionId` option to the decoded version ID in the
metadata call.

#### Delete Markers

In buckets that have been configured for versioning, the Delete Object API
action will not result in the deletion of an object or version unless a specific
version ID is provided in the request query, e.g. `DELETE /foo?versionId=v1`.
Likewise, if versioning has not been configured, the Multi-Object Delete API
will not result in the deletion of an object or version unless a specific
version ID is provided in the xml request for that object.

If no version ID is provided, a special version called a delete marker is
created. When getting or heading an object whose latest version is a delete
maker, the S3 API will return a `404 NoSuchKey` error and behave as if that
object has been deleted. To restore a previous version as the latest version of
an object, the delete marker must be deleted, by the same process as deleting
any other version.

The response varies when targeting an object whose latest version is a delete
marker for other object-level APIs that can target existing objects and
versions, without specifying the version ID.

- Get Object, Head Object, Get Object ACL, Object Copy and Copy Part return
  `404 NoSuchKey`.
- Put Object ACL and Put Object Tagging return `405 MethodNotAllowed`.

These APIs respond to requests specifying the version ID of a delete marker
with the error `405 MethodNotAllowed`, in general. Copy Part and Copy Object
respond with `400 Invalid Request`.

The metadata engine's versioning processing is agnostic to whether a specific
version is a delete marker. Instead, the S3 API stores information about whether
a version is a delete marker in its metadata and checks the object's metadata
to determine whether a version is a delete marker. See section "Delete Example"
for more information.

#### Null Version Mapping

When the null version is specified in a request with the version ID "null", the
S3 API must use the `nullVersionId` stored in the latest version to retrieve
the current null version, if the null version is not the latest version.

Thus, getting the null version is a two step process:

1. Get the latest version of the object from metadata. If the latest version's
  `isNull` property is `true`, then use the latest version's metadata.
  Otherwise,
2. Get the null version of the object from metadata, using the internal version
  ID of the current null version stored in the latest version's `nullVersionId`
  metadata attribute.

### DELETE Example

The following steps are used in the delete logic for delete marker creation:

- If versioning has not been configured: attempt to delete the object
- If request is version-specific delete request: attempt to delete the version
- otherwise, if not a version-specific delete request and versioning has been
  configured:
    - create a new 0-byte content-length version
    - in version's metadata, set a 'isDeleteMarker' property to true
- Return the version ID of any version deleted or any delete marker created
- Set response header `x-amz-delete-marker` to true if a delete marker
  was deleted or created

The Multi-Object Delete API follows the same logic for each of the objects or
versions listed in an xml request. Note that a delete request can result in
the creation of a deletion marker even if the object requested to delete does
not exist in the first place.

Object-level APIs which can target existing objects and versions perform the
following checks regarding delete markers:

- If not a version-specific request and versioning has been configured, check
  the metadata of the latest version
  - If the 'isDeleteMarker' property is set to true, return `404 NoSuchKey`
    or `405 MethodNotAllowed`
- If it is a version-specific request, check the object metadata of the
  requested version
- If the `isDeleteMarker` property is set to true, return `405 MethodNotAllowed`
  or `400 InvalidRequest`
